<h4 id="写在前面"><a href="#写在前面" class="headerlink" title="写在前面"></a>写在前面</h4><p>原想着这个寒假主要的学习任务就是阅读python源码，但是碍于一直在写论文，现在才开始着手学习。其实想看python源码的目的很简单，一来对python很感兴趣，想了解它的工作原理。二来以后可能也想从事这方面的工作，所以希望能加深对python的理解。关于阅读源码的总结也会记录下来，跟大家一块分享。这里主要分析的python源码是3.6.0版本的，如果在分析中出现了由于版本不同所带来的问题，欢迎大家一块讨论。<br>阅读源码一定要有目的性，特别是这种大型的编译系统。所以在这里列下一个阅读目标列表及记录完成时间，这个列表也会随着我阅读的情况不断更新。最后的文章也会根据这个的顺序来排布。</p>
<ol>
<li>数据类型<br>1.1 基本类 object<br>1.2 整型类<br>1.3 字符串类<br>1.4 list类<br>1.5 tuple类<br>1.6 dict类</li>
<li>内建函数<br>…</li>
</ol>
<a id="more"></a>
<h4 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h4><h5 id="编译环境"><a href="#编译环境" class="headerlink" title="编译环境"></a>编译环境</h5><p>首先需要准备python的源码，可以在<a href="http://www.python.org/" target="_blank" rel="external">python官方网站</a>下载。其次是需要一个编译器，<a href="https://docs.python.org/devguide/index.html" target="_blank" rel="external">开发者文档</a>中有详细说明如何编译python，我这里主要使用的是Windows系统，所以选用<a href="https://www.visualstudio.com/" target="_blank" rel="external">Visual Studio 2015</a> 作为编译环境。<br>CPython中使用<a href="http://hg-scm.org/" target="_blank" rel="external">Mercurial</a>作为版本控制工具，并且在编译的过程中也使用了Mercurial相关的命令，所以这里需要提前安装好Mercurial。在Unix系统下可以直接用apt-get来安装。在Windows系统下，使用<a href="http://tortoisehg.org/" target="_blank" rel="external">TortoiseHg</a>会跟好一点，这个里面集成了Mercurial。注意在安装完TortoiseHg之后查看一下系统环境变量Path中是否包含了TortoiseHg路径</p>
<p>安装完Mercurial之后，可以查看一下hg指令是否可以用，如果可以用的话就可以进行下一步了。</p>
<p>Windows下的源码编译文件都在PCbuild文件夹下，进入这个文件夹之后，查看readme.txt文件，我们可以根据这个文件的指导来编译。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">Quick Start Guide</div><div class="line">-----------------</div><div class="line">1.  Install Microsoft Visual Studio 2015, any edition.</div><div class="line">2.  Install Subversion, and make sure &apos;svn.exe&apos; is on your PATH.</div><div class="line">3.  Run &quot;build.bat -e&quot; to build Python in 32-bit Release configuration.</div><div class="line">4.  (Optional, but recommended) Run the test suite with &quot;rt.bat -q&quot;.</div></pre></td></tr></table></figure>
<p>根据上面的步骤，我们还需要安装Subversion以确保svn指令能正确执行。我们去<a href="http://subversion.apache.org/" target="_blank" rel="external">Subversion</a>下载一个即可。在下载页面中对应的Windows版本下有很多镜像网站，选一个下载速度快一点的就可以了。不想那么麻烦的话可以直接在这里下载(<a href="https://www.visualsvn.com/files/Apache-Subversion-1.9.5.zip" target="_blank" rel="external">Apache Subversion command line tools</a>)。下载下来后解压缩出来，然后把其中bin文件的路径添加到系统环境变量Path中，然后进入cmd测试一下svn指令是否可以使用，如果可以的话我们就可以开始编译了。</p>
<h5 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h5><p>在PCbuild目录下执行”build.bat -e”,即可开始编译，编译过程大概需要15分钟左右。编译结束之后应该会在当前文件夹下面生成两个文件夹obj和win32。我们进入win32可以看到里面有一个python.exe文件，这个就是我们编译出来的python编译程序。我们可以执行以下这个文件，查看一下是否完整。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Python 3.6.0 (default, Feb  5 2017, 00:57:29) [MSC v.1900 32 bit (Intel)] on win</div><div class="line">32</div><div class="line">Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.</div><div class="line">&gt;&gt;&gt;</div></pre></td></tr></table></figure>
<p>上面那个时间是这个程序的编译时间。</p>
<p>回到PCbuild文件夹，执行一下”rt.bat -q”测试是否成功。这个测试会消耗一定的时间，它会运行405个测试文件。<br>下面是测试完成之后显示的结果。具体这些测试错误的原因还没有找到，但是目前还不妨碍使用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">359 tests OK.</div><div class="line"></div><div class="line">2 tests failed:</div><div class="line">    test_strptime test_time</div><div class="line"></div><div class="line">1 test altered the execution environment:</div><div class="line">    test_site</div><div class="line"></div><div class="line">43 tests skipped:</div><div class="line">    test_crypt test_curses test_dbm_gnu test_dbm_ndbm test_devpoll</div><div class="line">    test_epoll test_fcntl test_fork1 test_gdb test_grp test_idle</div><div class="line">    test_ioctl test_kqueue test_nis test_openpty test_ossaudiodev</div><div class="line">    test_pipes test_poll test_posix test_pty test_pwd test_readline</div><div class="line">    test_resource test_smtpnet test_socketserver test_spwd test_ssl</div><div class="line">    test_syslog test_tcl test_threadsignals test_timeout test_tix</div><div class="line">    test_tk test_ttk_guionly test_ttk_textonly test_turtle</div><div class="line">    test_urllib2net test_urllibnet test_wait3 test_wait4 test_winsound</div><div class="line">    test_xmlrpc_net test_zipfile64</div><div class="line"></div><div class="line">Total duration: 16 min 54 sec</div><div class="line">Tests result: FAILURE</div><div class="line">Windows fatal exception: code 1073807366</div><div class="line">Windows fatal exception: code 1073807366</div><div class="line">Windows fatal exception: code 1073807366</div><div class="line">Windows fatal exception: code 1073807366</div><div class="line">Windows fatal exception: code 1073807366</div><div class="line">Windows fatal exception: code 1073807366</div></pre></td></tr></table></figure>
<p>测试完成之后，我们的准备工作也就完成了，之后在阅读源码的时候会经常修改源码，然后编译来查看效果。    </p>
